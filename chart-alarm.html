<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ECharts Realtime Chart</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<style>
    .chart-row {
        display: flex;
        justify-content: space-around;
        margin-bottom: 10px;
    }
    .chart-container {
        width: 48%;
        height: 300px;
    }
    @media (max-width: 1280px) {
        .chart-container {
            width: 100%;
        }
        .chart-row {
            flex-direction: column;
        }
    }
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
    }
    th, td {
        padding: 10px;
    }
</style>
</head>
<body>

<div class="chart-row">
    <div id="chart0" class="chart-container"></div>
    <div id="chart1" class="chart-container"></div>
</div>
<div class="chart-row">
    <div id="chart2" class="chart-container"></div>
    <div id="chart3" class="chart-container"></div>
</div>
<div class="chart-row">
    <div id="chart4" class="chart-container"></div>
    <div id="chart5" class="chart-container"></div>
</div>
<div class="chart-row">
    <div id="table-container"></div>
</div>

<script>
var charts = [];
var options = [];
var titles = [
    'Realtime Data Chart : Vibration',
    'Realtime Data Chart : TAG-SENSOR1',
    'Realtime Data Chart : TAG-SENSOR2',
    'Realtime Data Chart : TAG-SENSOR3',
    'Realtime Data Chart : TAG-SENSOR4',
    'Realtime Data Chart : TAG-SENSOR5'
];
var lineColors = ['purple', '', 'black', 'magenta', 'green', 'red'];

for (var i = 0; i < 6; i++) {
    var chartDom = document.getElementById('chart' + i);
    var myChart = echarts.init(chartDom);
    charts.push(myChart);

    var option = {
        title: { text: titles[i] },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: [] },
        yAxis: { type: 'value' },
        series: [{
            data: [], type: 'line', smooth: true,
            lineStyle: { color: lineColors[i] }
        }]
    };

    options.push(option);
}

window.addEventListener('resize', function () {
    charts.forEach(function(chart) {
        chart.resize();
    });
});

function fetchData() {
    fetchDataSync();
    
    charts.forEach(function(chart, i) {
            if (i === 0) return; // i가 0일 경우 이후 코드를 실행하지 않고 루프의 다음 반복으로 넘어갑니다.

            var tag = 'TAG-SENSOR' + i; // i가 0이 아닐 때만 실행됩니다.
            fetch('http://127.0.0.1:5654/db/tql/autoload/chart1-data.tql?tag=' + tag)
                  .then(response => response.json())
                  .then((data) => {
                          var option = options[i];
                          option.xAxis.data = data.data.rows.map(row => row[0]);
                          option.series[0].data = data.data.rows.map(row => row[1]);
                          chart.setOption(option);
                   })
                  .catch(error => console.error('Error fetching data: ', error));
    });

    var tag =  'vibration';
    fetch('http://127.0.0.1:5654/db/tql/autoload/chart2-vibration.tql?tag=vibration')
        .then(response => response.json())
        .then((data) => {
            var option = options[0];
            option.xAxis.data = data.data.rows.map(row => row[0]);
            option.series[0].data = data.data.rows.map(row => row[1]);
            charts[0].setOption(option);
        })
        .catch(error => console.error('Error fetching data: ', error));

      // 동기식 API 호출 함수
        function fetchDataSync() {
            var request = new XMLHttpRequest();
            request.open('GET', 'http://127.0.0.1:5654/db/tql/autoload/alarm1-data.tql', false); // false로 설정하여 동기식으로 변경
            request.send(null);

            if (request.status === 200) {
                var jsonData = JSON.parse(request.responseText);
                if (jsonData.success && jsonData.data.rows) {
                    // 테이블 생성 함수 호출
                    createTable(jsonData.data.rows);
                } else {
                    console.error('데이터를 가져오는데 실패했습니다:', jsonData.reason);
                }
            } else {
                console.error('API 호출 실패:', request.statusText);
            }
        }

        // 데이터를 기반으로 테이블 생성하는 함수
        function createTable(rows) {
            const container = document.getElementById('table-container');
            let table = '<table><tr><th>NAME</th><th>TIME</th><th>VALUE</th></tr>';

            // 각 행에 대한 데이터 처리
            rows.forEach(row => {
                table += `<tr>
                            <td>${row[0]}</td> <!-- NAME -->
                            <td>${row[1]}</td> <!-- TIME -->
                            <td>${row[2]}</td> <!-- VALUE -->
                          </tr>`;
            });

            table += '</table>';
            container.innerHTML = table; // 생성된 테이블로 컨테이너 업데이트
        }

}

setInterval(fetchData, 1000);
</script>

</body>
</html>
